import time
import pytest
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

PRODUCT_URL = "http://www.selenium-shop.pl/produkt/koszulka-manchester-fc-city/"
CART_URL = "http://www.selenium-shop.pl/koszyk/"
INVALID_COUPON = "XYZ123"


@pytest.fixture
def driver():
    driver = webdriver.Chrome()
    driver.maximize_window()
    yield driver
    driver.quit()


def test_niepoprawny_kupon_wyswietla_blad(driver):
    # 1. Wejdź na stronę produktu i dodaj do koszyka
    driver.get(PRODUCT_URL)
    WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, "button.single_add_to_cart_button"))
    ).click()

    # 2. Kliknij "Wyświetl koszyk"
    WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, ".woocommerce-message a"))
    ).click()

    # 3. Wpisz błędny kupon rabatowy
    WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.ID, "coupon_code"))
    ).send_keys(INVALID_COUPON)

    driver.find_element(By.NAME, "apply_coupon").click()

    # 4. Oczekiwany komunikat błędu
    error_box = WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.CSS_SELECTOR, "ul.woocommerce-error"))
    )
    error_text = error_box.text.lower()

    assert "nieprawidłowy" in error_text or "nie istnieje" in error_text, \
        f"❌ Komunikat nie zawiera informacji o błędnym kuponie! Otrzymano: {error_text}"

    #  Pauza 3 sekundy, aby zobaczyć efekt na stronie
    time.sleep(3)
