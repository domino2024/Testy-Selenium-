import pytest
import time
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC

PRODUCT_URL = "http://www.selenium-shop.pl/produkt/koszulka-manchester-fc-city/"
CART_URL = "http://www.selenium-shop.pl/koszyk/"
CHECKOUT_URL = "http://www.selenium-shop.pl/zamowienie/"

@pytest.fixture
def driver():
    driver = webdriver.Chrome()
    driver.maximize_window()
    yield driver
    driver.quit()

def test_bledny_adres_i_telefon_blokuje_zamowienie(driver):
    driver.get(PRODUCT_URL)

    qty = WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.CSS_SELECTOR, "input.qty"))
    )
    qty.clear()
    qty.send_keys("2")

    add_btn = WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, "button.single_add_to_cart_button"))
    )
    add_btn.click()

    WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.CSS_SELECTOR, ".woocommerce-message a"))
    ).click()

    WebDriverWait(driver, 10).until(
        EC.element_to_be_clickable((By.CSS_SELECTOR, ".checkout-button"))
    ).click()

    WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.ID, "billing_first_name"))
    ).send_keys("Jan")

    driver.find_element(By.ID, "billing_last_name").send_keys("Kowalski")
    driver.find_element(By.ID, "billing_email").send_keys("jan@test.com")
    driver.find_element(By.ID, "billing_address_1").send_keys("?")  # ❌ zły adres
    driver.find_element(By.ID, "billing_city").send_keys("Warszawa")
    driver.find_element(By.ID, "billing_postcode").send_keys("00-001")
    driver.find_element(By.ID, "billing_phone").send_keys("abcd123")  # ❌ zły telefon

    driver.find_element(By.ID, "place_order").click()

    error_box = WebDriverWait(driver, 10).until(
        EC.visibility_of_element_located((By.CSS_SELECTOR, "ul.woocommerce-error"))
    )
    error_text = error_box.text.lower()

    assert "telefon" in error_text or "adres" in error_text, \
        f"Komunikat błędu nie zawiera 'telefon' ani 'adres'! Otrzymano: {error_text}"


    time.sleep(3)

